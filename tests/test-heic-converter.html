<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEIC Converter Tests - iresized.com</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 { color: #D4A84B; }
        h2 { color: #8B7355; margin-top: 30px; }
        #test-output {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-suite { color: #D4A84B; font-weight: bold; margin-top: 15px; }
        .test-pass { color: #4CAF50; }
        .test-fail { color: #f44336; }
        .test-info { color: #888; }
        #test-summary {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 16px;
        }
        button {
            background: #D4A84B;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        button:hover { background: #c49a3f; }
        .manual-test {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .manual-test h3 { color: #D4A84B; margin-top: 0; }
        input[type="file"] {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            color: #e0e0e0;
            margin: 10px 0;
            display: block;
        }
        select, input[type="range"] {
            background: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 10px 5px 0;
        }
        .controls {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .image-preview {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .image-preview div {
            text-align: center;
        }
        .image-preview img {
            max-width: 300px;
            max-height: 300px;
            border: 2px solid #444;
            border-radius: 4px;
        }
        .file-list {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #444;
        }
        .file-item:last-child { border-bottom: none; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pending { background: #888; }
        .status-processing { background: #D4A84B; }
        .status-done { background: #4CAF50; }
        .status-error { background: #f44336; }
    </style>
</head>
<body>
    <h1>HEIC Converter Tests</h1>
    <p>Tests for HEIC/HEIF to JPEG/PNG/WebP conversion functionality.</p>

    <button onclick="runTests()">Run Automated Tests</button>
    <button onclick="TestUtils.reset()">Clear</button>

    <div id="test-summary"></div>
    <div id="test-output"></div>

    <div class="manual-test">
        <h3>Manual Test: Convert HEIC Files</h3>
        <p>Upload HEIC/HEIF files from an iPhone or other source to test conversion.</p>

        <input type="file" id="heic-file-input" accept=".heic,.heif,image/heic,image/heif" multiple>

        <div class="file-list" id="file-list" style="display: none;"></div>

        <div class="controls">
            <label>Format:
                <select id="output-format">
                    <option value="jpeg">JPEG</option>
                    <option value="png">PNG</option>
                    <option value="webp">WebP</option>
                </select>
            </label>
            <label>Quality: <span id="quality-display">85%</span>
                <input type="range" id="quality-slider" min="10" max="100" value="85">
            </label>
            <button onclick="runManualConvert()">Convert</button>
        </div>

        <div id="manual-result"></div>
        <div class="image-preview" id="manual-preview"></div>
    </div>

    <script src="test-utils.js"></script>
    <script src="../libs/heic2any.min.js"></script>
    <script src="../libs/jszip.min.js"></script>
    <script>
        // File list state
        let selectedFiles = [];

        // UI Elements
        const fileInput = document.getElementById('heic-file-input');
        const fileListDiv = document.getElementById('file-list');
        const qualitySlider = document.getElementById('quality-slider');
        const qualityDisplay = document.getElementById('quality-display');
        const resultDiv = document.getElementById('manual-result');
        const previewDiv = document.getElementById('manual-preview');

        // Quality slider update
        qualitySlider.addEventListener('input', () => {
            qualityDisplay.textContent = qualitySlider.value + '%';
        });

        // File input handler
        fileInput.addEventListener('change', (e) => {
            selectedFiles = Array.from(e.target.files).filter(f => {
                const name = f.name.toLowerCase();
                return name.endsWith('.heic') || name.endsWith('.heif');
            });

            if (selectedFiles.length === 0) {
                fileListDiv.style.display = 'none';
                resultDiv.innerHTML = '<p style="color: #f44336;">No HEIC/HEIF files selected.</p>';
                return;
            }

            // Show file list
            fileListDiv.style.display = 'block';
            fileListDiv.innerHTML = selectedFiles.map((f, i) => `
                <div class="file-item" id="file-item-${i}">
                    <span><span class="status-indicator status-pending" id="status-${i}"></span>${f.name}</span>
                    <span>${(f.size / 1024).toFixed(1)} KB</span>
                </div>
            `).join('');

            resultDiv.innerHTML = `<p>${selectedFiles.length} file(s) ready for conversion.</p>`;
        });

        /**
         * Sanitize filename (mirror from script.js)
         */
        function sanitizeFilename(name) {
            if (typeof name !== 'string') return 'image';
            return name
                .replace(/\.\./g, '')
                .replace(/[/\\]/g, '')
                .replace(/[<>:"|?*\x00-\x1f]/g, '-')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^\.+/, '')
                .substring(0, 200)
                .trim() || 'image';
        }

        /**
         * Format file size
         */
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        /**
         * Run manual conversion test
         */
        async function runManualConvert() {
            if (selectedFiles.length === 0) {
                resultDiv.innerHTML = '<p style="color: #f44336;">Please select HEIC files first.</p>';
                return;
            }

            const format = document.getElementById('output-format').value;
            const quality = parseInt(qualitySlider.value) / 100;
            const mimeType = `image/${format === 'jpg' ? 'jpeg' : format}`;

            resultDiv.innerHTML = '<p>Converting...</p>';
            previewDiv.innerHTML = '';

            const results = [];
            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const statusEl = document.getElementById(`status-${i}`);
                statusEl.className = 'status-indicator status-processing';

                try {
                    const startTime = performance.now();

                    const blob = await heic2any({
                        blob: file,
                        toType: mimeType,
                        quality: quality
                    });

                    const resultBlob = Array.isArray(blob) ? blob[0] : blob;
                    const endTime = performance.now();

                    statusEl.className = 'status-indicator status-done';
                    successCount++;

                    results.push({
                        name: file.name,
                        originalSize: file.size,
                        convertedSize: resultBlob.size,
                        time: (endTime - startTime).toFixed(0),
                        blob: resultBlob
                    });

                } catch (err) {
                    statusEl.className = 'status-indicator status-error';
                    errorCount++;
                    console.error(`Error converting ${file.name}:`, err);

                    results.push({
                        name: file.name,
                        error: err.message
                    });
                }
            }

            // Show results
            let html = `<p><strong>Conversion Complete:</strong> ${successCount} succeeded, ${errorCount} failed</p>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<tr style="border-bottom: 1px solid #555;"><th>File</th><th>Original</th><th>Converted</th><th>Time</th></tr>';

            results.forEach(r => {
                if (r.error) {
                    html += `<tr><td>${r.name}</td><td colspan="3" style="color: #f44336;">Error: ${r.error}</td></tr>`;
                } else {
                    const ratio = ((r.convertedSize / r.originalSize) * 100).toFixed(0);
                    html += `<tr>
                        <td>${r.name}</td>
                        <td>${formatFileSize(r.originalSize)}</td>
                        <td>${formatFileSize(r.convertedSize)} (${ratio}%)</td>
                        <td>${r.time}ms</td>
                    </tr>`;
                }
            });
            html += '</table>';

            resultDiv.innerHTML = html;

            // Show previews (first 4 successful)
            const successResults = results.filter(r => !r.error).slice(0, 4);
            if (successResults.length > 0) {
                previewDiv.innerHTML = successResults.map(r => `
                    <div>
                        <p>${r.name.replace(/\.(heic|heif)$/i, '')}.${format}</p>
                        <img src="${URL.createObjectURL(r.blob)}">
                        <p><a href="${URL.createObjectURL(r.blob)}" download="${sanitizeFilename(r.name.replace(/\.(heic|heif)$/i, ''))}.${format}" style="color: #D4A84B;">Download</a></p>
                    </div>
                `).join('');
            }

            // If multiple files, offer ZIP download
            if (successResults.length > 1) {
                const zip = new JSZip();
                successResults.forEach(r => {
                    const baseName = r.name.replace(/\.(heic|heif)$/i, '');
                    zip.file(`${sanitizeFilename(baseName)}.${format}`, r.blob);
                });

                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const zipUrl = URL.createObjectURL(zipBlob);

                resultDiv.innerHTML += `<p style="margin-top: 15px;"><a href="${zipUrl}" download="converted_images.zip" style="color: #D4A84B; font-size: 16px;">Download All as ZIP</a></p>`;
            }
        }

        /**
         * Run automated tests
         */
        async function runTests() {
            TestUtils.reset();
            const T = TestUtils;

            // ===============================
            // Library Loading Tests
            // ===============================
            T.suite('Library Loading');

            T.test('heic2any library is loaded', () => {
                T.assertNotNull(window.heic2any, 'heic2any should be defined');
            });

            T.test('JSZip library is loaded', () => {
                T.assertNotNull(window.JSZip, 'JSZip should be defined');
            });

            // ===============================
            // File Validation Tests
            // ===============================
            T.suite('File Validation Logic');

            T.test('accepts .heic extension', () => {
                const isHeic = name => name.toLowerCase().endsWith('.heic') || name.toLowerCase().endsWith('.heif');
                T.assertTrue(isHeic('photo.HEIC'));
                T.assertTrue(isHeic('photo.heic'));
                T.assertTrue(isHeic('PHOTO.HEIC'));
            });

            T.test('accepts .heif extension', () => {
                const isHeic = name => name.toLowerCase().endsWith('.heic') || name.toLowerCase().endsWith('.heif');
                T.assertTrue(isHeic('photo.heif'));
                T.assertTrue(isHeic('photo.HEIF'));
            });

            T.test('rejects non-HEIC files', () => {
                const isHeic = name => name.toLowerCase().endsWith('.heic') || name.toLowerCase().endsWith('.heif');
                T.assertFalse(isHeic('photo.jpg'));
                T.assertFalse(isHeic('photo.png'));
                T.assertFalse(isHeic('photo.webp'));
            });

            // ===============================
            // Size Limit Tests
            // ===============================
            T.suite('Size Limits');

            T.test('enforces 50MB per file limit', () => {
                const MAX_FILE_SIZE = 50 * 1024 * 1024;
                T.assertEqual(MAX_FILE_SIZE, 52428800);

                const checkSize = (size) => size <= MAX_FILE_SIZE;
                T.assertTrue(checkSize(10 * 1024 * 1024)); // 10MB OK
                T.assertTrue(checkSize(50 * 1024 * 1024)); // 50MB OK
                T.assertFalse(checkSize(51 * 1024 * 1024)); // 51MB NOT OK
            });

            // ===============================
            // Filename Generation Tests
            // ===============================
            T.suite('Filename Generation');

            T.test('strips .heic extension', () => {
                const baseName = 'IMG_1234.heic'.replace(/\.(heic|heif)$/i, '');
                T.assertEqual(baseName, 'IMG_1234');
            });

            T.test('strips .HEIC extension (uppercase)', () => {
                const baseName = 'IMG_1234.HEIC'.replace(/\.(heic|heif)$/i, '');
                T.assertEqual(baseName, 'IMG_1234');
            });

            T.test('strips .heif extension', () => {
                const baseName = 'photo.heif'.replace(/\.(heic|heif)$/i, '');
                T.assertEqual(baseName, 'photo');
            });

            T.test('sanitizes output filename', () => {
                const baseName = '../../../etc/passwd.heic'.replace(/\.(heic|heif)$/i, '');
                const sanitized = sanitizeFilename(baseName);
                T.assertNotContains(sanitized, '..');
                T.assertNotContains(sanitized, '/');
            });

            // ===============================
            // MIME Type Tests
            // ===============================
            T.suite('MIME Type Handling');

            T.test('generates correct JPEG MIME type', () => {
                const format = 'jpeg';
                const mimeType = `image/${format === 'jpg' ? 'jpeg' : format}`;
                T.assertEqual(mimeType, 'image/jpeg');
            });

            T.test('generates correct PNG MIME type', () => {
                const format = 'png';
                const mimeType = `image/${format === 'jpg' ? 'jpeg' : format}`;
                T.assertEqual(mimeType, 'image/png');
            });

            T.test('generates correct WebP MIME type', () => {
                const format = 'webp';
                const mimeType = `image/${format === 'jpg' ? 'jpeg' : format}`;
                T.assertEqual(mimeType, 'image/webp');
            });

            // ===============================
            // ZIP Creation Tests
            // ===============================
            T.suite('ZIP Creation');

            await T.testAsync('creates valid ZIP with multiple files', async () => {
                const zip = new JSZip();

                // Add test blobs
                const blob1 = await TestUtils.createTestImageBlob(100, 100, '#ff0000');
                const blob2 = await TestUtils.createTestImageBlob(100, 100, '#00ff00');

                zip.file('image1.jpg', blob1);
                zip.file('image2.jpg', blob2);

                const zipBlob = await zip.generateAsync({ type: 'blob' });
                T.assertNotNull(zipBlob);
                T.assertGreaterThan(zipBlob.size, 0);
            });

            await T.testAsync('ZIP contains correct number of files', async () => {
                const zip = new JSZip();

                for (let i = 0; i < 5; i++) {
                    const blob = await TestUtils.createTestImageBlob(50, 50);
                    zip.file(`image_${i}.png`, blob);
                }

                const zipBlob = await zip.generateAsync({ type: 'blob' });

                // Read back
                const loadedZip = await JSZip.loadAsync(zipBlob);
                const fileCount = Object.keys(loadedZip.files).length;
                T.assertEqual(fileCount, 5);
            });

            // ===============================
            // Quality Settings Tests
            // ===============================
            T.suite('Quality Settings');

            T.test('quality slider range is valid', () => {
                const min = parseInt(qualitySlider.min);
                const max = parseInt(qualitySlider.max);
                T.assertEqual(min, 10);
                T.assertEqual(max, 100);
            });

            T.test('quality converts to 0-1 range correctly', () => {
                const quality85 = 85 / 100;
                const quality50 = 50 / 100;
                T.assertEqual(quality85, 0.85);
                T.assertEqual(quality50, 0.5);
            });

            T.summary();
        }

        // Auto-run on load
        window.onload = runTests;
    </script>
</body>
</html>
